<!-- Loading indicator -->
@if (isLoading) {
  <div class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading...</p>
  </div>
}

<!-- Error message -->
@if (error) {
  <div class="error-container">
    <p>{{ error }}</p>
  </div>
}

<!-- Smart Recommendations content -->
@if (!isLoading && !error) {
  <div class="recommendations-container">
    <!-- Recent History Section (integrated within Smart Recommendations) -->
    @if (recommendationHistory.length > 0 && !smartRecommendations.length) {
      <div class="history-section" [class.collapsed]="!showHistory">
        <div class="history-toggle-header">
          <button
            class="btn btn-secondary history-toggle-btn"
            (click)="onToggleHistory()"
          >
            <span class="material-icons">{{ showHistory ? 'expand_less' : 'history' }}</span>
            {{ showHistory ? 'Hide Recent History' : 'View Recent History' }}
            ({{ recommendationHistory.length }})
          </button>
        </div>

        @if (showHistory) {
          <div class="history-container">
            @if (selectedHistoryEntry) {
              <!-- Display selected history entry results -->
              <div class="selected-history-view">
              <div class="selected-history-header">
                <button
                  class="btn btn-secondary back-button"
                  (click)="onClearSelectedEntry()"
                >
                  <span class="material-icons">arrow_back</span>
                  Back to History
                </button>
                <div class="selected-query-info">
                  <h3>Previous Query Results</h3>
                  <p class="query-text">"{{ selectedHistoryEntry.query }}"</p>
                  <p class="query-date">{{ selectedHistoryEntry.dateString }}</p>
                </div>
              </div>

              @if (selectedHistoryEntry.reasoning) {
                <div class="recommendation-reasoning">
                  <h3>Why we recommended these:</h3>
                  <app-truncated-text
                    [text]="selectedHistoryEntry.reasoning || ''"
                    [maxLines]="6">
                  </app-truncated-text>
                </div>
              }

              <div class="media-grid">
                @for (recommendation of selectedHistoryEntry.recommendations || []; track recommendation.tmdbId) {
                  <app-media-card
                    [item]="{
                      id: recommendation.tmdbId,
                      title: recommendation.title,
                      name: recommendation.title,
                      overview: recommendation.overview,
                      poster_path: recommendation.poster_path.startsWith('/') ? recommendation.poster_path : '/' + recommendation.poster_path,
                      backdrop_path: '',
                      vote_average: recommendation.vote_average,
                      popularity: 0,
                      vote_count: 0,
                      genre_ids: [],
                      adult: false,
                      original_language: '',
                      release_date: recommendation.release_date,
                      first_air_date: recommendation.release_date,
                      origin_country: [],
                      original_name: recommendation.title
                    }"
                    [type]="recommendation.type === 'movie' ? 'movie' : 'tvshow'"
                    (share)="onShareMedia({
                      item: {
                        id: recommendation.tmdbId,
                        title: recommendation.title,
                        name: recommendation.title,
                        overview: recommendation.overview,
                        poster_path: recommendation.poster_path.startsWith('/') ? recommendation.poster_path : '/' + recommendation.poster_path,
                        backdrop_path: '',
                        vote_average: 0,
                        popularity: 0,
                        vote_count: 0,
                        genre_ids: [],
                        adult: false,
                        original_language: '',
                        release_date: '',
                        first_air_date: '',
                        origin_country: [],
                        original_name: recommendation.title
                      },
                      type: recommendation.type
                    })">
                  </app-media-card>
                }
              </div>
              </div>
            } @else {
              <!-- Display history list -->
              <div class="history-list-view">
              <div class="history-header">
                <h3>Recent Recommendation History</h3>
                <p class="history-description">
                  Click on any previous query to view its recommendations again
                </p>
                <button
                  class="btn btn-secondary clear-history-btn"
                  (click)="onClearAllHistory()"
                >
                  Clear All History
                </button>
              </div>

              <div class="history-list">
                @for (entry of recommendationHistory; track entry.id) {
                  <div class="history-item" (click)="onLoadHistoryEntry(entry)">
                    <div class="history-item-content">
                      <div class="query-preview">
                        <h4>"{{ entry.query }}"</h4>
                        <p class="results-count">
                          {{ entry.recommendations.length }} recommendation{{ entry.recommendations.length !== 1 ? 's' : '' }}
                        </p>
                      </div>
                      <div class="history-item-meta">
                        <span class="history-date">{{ entry.dateString }}</span>
                        <button
                          class="btn-icon delete-btn"
                          (click)="onRemoveHistoryEntry($event, entry.id)"
                          title="Remove this entry"
                        >
                          <span class="material-icons">delete</span>
                        </button>
                      </div>
                    </div>
                    <span class="material-icons arrow-icon">chevron_right</span>
                  </div>
                }
              </div>
              </div>
            }
          </div>
        }
      </div>
    }

    <!-- Natural Language Query Input -->
    <div class="natural-language-input">
      <h3>Tell us what you're in the mood for</h3>
      <p class="input-description">
        Describe what you want to watch in natural language, like "I want a thrilling, suspenseful movie"
        or "My niece likes cartoons that have sci-fi in them. Recommend me some."
      </p>
      <div class="query-input-container">
        <textarea
          class="query-input"
          placeholder="E.g., I want something thrilling and suspenseful, or cartoons with sci-fi for my niece..."
          rows="3"
          [value]="naturalLanguageQuery"
          (input)="onQueryInput($event)"
        ></textarea>
        <div class="query-buttons">
          <button
            class="btn btn-primary"
            (click)="onGetRecommendations()"
            [disabled]="!naturalLanguageQuery.trim()"
          >
            Get Smart Recommendations
          </button>
          @if (naturalLanguageQuery) {
            <button
              class="btn btn-secondary"
              (click)="onClearQuery()"
            >
              Clear Query
            </button>
          }
        </div>
      </div>
    </div>

    @if (smartRecommendations.length === 0 && !selectedHistoryEntry) {
      <div class="recommendations-placeholder">
        <p>No recommendations available yet.</p>
        @if (!naturalLanguageQuery) {
          <p>Try describing what you want to watch above!</p>
        } @else {
          <p>Try adjusting your query for better results.</p>
        }
      </div>
    } @else {
      @if (smartRecommendationReasoning) {
        <div class="recommendation-reasoning">
          <h3>Why we recommend these:</h3>
          <app-truncated-text
            [text]="smartRecommendationReasoning || ''"
            [maxLines]="6">
          </app-truncated-text>
        </div>
      }

      <div class="media-grid">
        @for (recommendation of smartRecommendations; track recommendation.tmdbId) {
          <app-media-card
            [item]="{
              id: recommendation.tmdbId,
              title: recommendation.title,
              name: recommendation.title,
              overview: recommendation.overview,
              poster_path: recommendation.poster_path.startsWith('/') ? recommendation.poster_path : '/' + recommendation.poster_path,
              backdrop_path: '',
              vote_average: recommendation.vote_average,
              popularity: 0,
              vote_count: 0,
              genre_ids: [],
              adult: false,
              original_language: '',
              release_date: recommendation.release_date,
              first_air_date: recommendation.release_date,
              origin_country: [],
              original_name: recommendation.title
            }"
            [type]="recommendation.type === 'movie' ? 'movie' : 'tvshow'"
            (share)="onShareMedia({
              item: {
                id: recommendation.tmdbId,
                title: recommendation.title,
                name: recommendation.title,
                overview: recommendation.overview,
                poster_path: recommendation.poster_path.startsWith('/') ? recommendation.poster_path : '/' + recommendation.poster_path,
                backdrop_path: '',
                vote_average: 0,
                popularity: 0,
                vote_count: 0,
                genre_ids: [],
                adult: false,
                original_language: '',
                release_date: '',
                first_air_date: '',
                origin_country: [],
                original_name: recommendation.title
              },
              type: recommendation.type
            })">
          </app-media-card>
        }
      </div>

      <div class="refresh-recommendations">
        <button class="btn btn-primary" (click)="onRefreshRecommendations()">
          Refresh Recommendations
        </button>
      </div>
    }
  </div>
}
