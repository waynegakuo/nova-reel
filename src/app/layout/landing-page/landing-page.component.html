<section class="landing-container">
  <div class="header">
    <h1>Welcome to {{ title() }}</h1>
    <p class="subtitle">Discover the best movies and TV shows</p>

    <!-- Search bar -->
    <app-search-bar
      placeholder="Search for movies or TV shows..."
      [debounceTime]="500"
      (search)="onSearch($event)"
      (clear)="clearSearch()"
    ></app-search-bar>

    <!-- Search Results -->
    @if (showSearchResults()) {
      @if (isSearching() && searchResults().length === 0) {
        <div class="search-loading-container">
          <div class="loading-spinner"></div>
          <p>{{ loadingMessagesService.getSearchingMessage() }}</p>
        </div>
      } @else {
        <app-search-results
          [results]="searchResults()"
          [query]="searchQuery()"
          [type]="searchType()"
          [currentPage]="currentSearchPage()"
          [maxPages]="MAX_PAGES"
          (pageChange)="goToSearchPage($event)"
          (resultClick)="navigateToDetails($event.item, $event.type)"
        ></app-search-results>
      }
    }
  </div>

  <app-tab-navigation
    [tabs]="tabsConfig"
    [activeTab]="activeTab()"
    (tabChange)="setActiveTab($event)">
  </app-tab-navigation>

  <div class="content">
    <!-- Category selectors - always visible based on active tab -->
    @if (activeTab() === 'Movies') {
      <app-category-selector
        [categories]="movieCategories"
        [activeCategory]="activeMovieCategory()"
        (categoryChange)="loadMovies($event)">
      </app-category-selector>
    } @else if (activeTab() === 'TV Shows') {
      <app-category-selector
        [categories]="tvShowCategories"
        [activeCategory]="activeTVShowCategory()"
        (categoryChange)="loadTVShows($event)">
      </app-category-selector>
    }

    <!-- Dynamic content area that refreshes -->
    <div class="dynamic-content">
      <!-- Loading indicator -->
      @if (isLoading()) {
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <p>{{ loadingMessagesService.getLoadingMessage() }}</p>
        </div>
      }

      <!-- Error message -->
      @if (error()) {
        <div class="error-container">
          <p>{{ error() }}</p>
          <button class="btn btn-primary" (click)="activeTab() === 'Movies' ? loadMovies('popular') : loadTVShows('popular')">
            Try Again
          </button>
        </div>
      }

      <!-- Movies tab content -->
      @if (activeTab() === 'Movies' && !isLoading() && !error()) {
        <app-media-grid
          [items]="movies()"
          type="movie"
          emptyMessage="No movies found."
          (share)="onShareMedia($event)">
        </app-media-grid>

        <app-pagination-controls
          [currentPage]="currentMoviePage()"
          [maxPages]="MAX_PAGES"
          [totalPages]="MAX_PAGES"
          (pageChange)="goToMoviePage($event)">
        </app-pagination-controls>
      }

      <!-- TV Shows tab content -->
      @if (activeTab() === 'TV Shows' && !isLoading() && !error()) {
        <app-media-grid
          [items]="tvShows()"
          type="tvshow"
          emptyMessage="No TV shows found."
          (share)="onShareMedia($event)">
        </app-media-grid>

        <app-pagination-controls
          [currentPage]="currentTVShowPage()"
          [maxPages]="MAX_PAGES"
          [totalPages]="MAX_PAGES"
          (pageChange)="goToTVShowPage($event)">
        </app-pagination-controls>
      }

      <!-- Favorites tab content -->
      @if (activeTab() === 'Favorites' && !isLoading() && !error()) {
        @if (favorites().length === 0) {
          <div class="favorites-placeholder">
            <p>You haven't added any favorites yet</p>
          </div>
        } @else {
          <app-media-grid
            [items]="favorites()"
            [type]="'movie'"
            emptyMessage="You haven't added any favorites yet"
            (share)="onShareMedia($event)">
          </app-media-grid>
        }
      }


      <!--
        Smart Recommendations tab content
        This section provides natural language query input for AI-powered recommendations
        without requiring favorites to be loaded first, improving performance.
      -->
      @if (activeTab() === 'Smart Recommendations' && !isLoading() && !error()) {
        <div class="recommendations-container">
          <!-- Recent History Section (integrated within Smart Recommendations) -->
          @if (recommendationHistory().length > 0 && !aiRecommendations().length) {
            <div class="history-section" [class.collapsed]="!showHistory()">
              <div class="history-toggle-header">
                <button
                  class="btn btn-secondary history-toggle-btn"
                  (click)="toggleHistoryView()"
                >
                  <span class="material-icons">{{ showHistory() ? 'expand_less' : 'history' }}</span>
                  {{ showHistory() ? 'Hide Recent History' : 'View Recent History' }}
                  ({{ recommendationHistory().length }})
                </button>
              </div>

              @if (showHistory()) {
                <div class="history-container">
                  @if (selectedHistoryEntry()) {
                    <!-- Display selected history entry results -->
                    <div class="selected-history-view">
                    <div class="selected-history-header">
                      <button
                        class="btn btn-secondary back-button"
                        (click)="clearSelectedHistoryEntry()"
                      >
                        <span class="material-icons">arrow_back</span>
                        Back to History
                      </button>
                      <div class="selected-query-info">
                        <h3>Previous Query Results</h3>
                        <p class="query-text">"{{ selectedHistoryEntry()?.query }}"</p>
                        <p class="query-date">{{ selectedHistoryEntry()?.dateString }}</p>
                      </div>
                    </div>

                    @if (selectedHistoryEntry()?.reasoning) {
                      <div class="recommendation-reasoning">
                        <h3>Why we recommended these:</h3>
                        <p>{{ selectedHistoryEntry()?.reasoning }}</p>
                      </div>
                    }

                    <div class="media-grid">
                      @for (recommendation of selectedHistoryEntry()?.recommendations || []; track recommendation.tmdbId) {
                        <app-media-card
                          [item]="{
                            id: recommendation.tmdbId,
                            title: recommendation.title,
                            name: recommendation.title,
                            overview: recommendation.overview,
                            poster_path: recommendation.poster_path.startsWith('/') ? recommendation.poster_path : '/' + recommendation.poster_path,
                            backdrop_path: '',
                            vote_average: recommendation.vote_average,
                            popularity: 0,
                            vote_count: 0,
                            genre_ids: [],
                            adult: false,
                            original_language: '',
                            release_date: recommendation.release_date,
                            first_air_date: recommendation.release_date,
                            origin_country: [],
                            original_name: recommendation.title
                          }"
                          [type]="recommendation.type === 'movie' ? 'movie' : 'tvshow'"
                          (share)="onShareMedia({
                            item: {
                              id: recommendation.tmdbId,
                              title: recommendation.title,
                              name: recommendation.title,
                              overview: recommendation.overview,
                              poster_path: recommendation.poster_path.startsWith('/') ? recommendation.poster_path : '/' + recommendation.poster_path,
                              backdrop_path: '',
                              vote_average: 0,
                              popularity: 0,
                              vote_count: 0,
                              genre_ids: [],
                              adult: false,
                              original_language: '',
                              release_date: '',
                              first_air_date: '',
                              origin_country: [],
                              original_name: recommendation.title
                            },
                            type: recommendation.type
                          })">
                        </app-media-card>
                      }
                    </div>
                    </div>
                  } @else {
                    <!-- Display history list -->
                    <div class="history-list-view">
                    <div class="history-header">
                      <h3>Recent Recommendation History</h3>
                      <p class="history-description">
                        Click on any previous query to view its recommendations again
                      </p>
                      <button
                        class="btn btn-secondary clear-history-btn"
                        (click)="historyService.clearHistory()"
                      >
                        Clear All History
                      </button>
                    </div>

                    <div class="history-list">
                      @for (entry of recommendationHistory(); track entry.id) {
                        <div class="history-item" (click)="loadHistoryEntry(entry)">
                          <div class="history-item-content">
                            <div class="query-preview">
                              <h4>"{{ entry.query }}"</h4>
                              <p class="results-count">
                                {{ entry.recommendations.length }} recommendation{{ entry.recommendations.length !== 1 ? 's' : '' }}
                              </p>
                            </div>
                            <div class="history-item-meta">
                              <span class="history-date">{{ entry.dateString }}</span>
                              <button
                                class="btn-icon delete-btn"
                                (click)="$event.stopPropagation(); historyService.removeHistoryEntry(entry.id)"
                                title="Remove this entry"
                              >
                                <span class="material-icons">delete</span>
                              </button>
                            </div>
                          </div>
                          <span class="material-icons arrow-icon">chevron_right</span>
                        </div>
                      }
                    </div>
                    </div>
                  }
                </div>
              }
            </div>
          }

          <!-- Natural Language Query Input -->
          <div class="natural-language-input">
            <h3>Tell us what you're in the mood for</h3>
            <p class="input-description">
              Describe what you want to watch in natural language, like "I want a thrilling, suspenseful movie"
              or "My niece likes cartoons that have sci-fi in them. Recommend me some."
            </p>
            <div class="query-input-container">
              <textarea
                class="query-input"
                placeholder="E.g., I want something thrilling and suspenseful, or cartoons with sci-fi for my niece..."
                rows="3"
                [value]="naturalLanguageQuery()"
                (input)="naturalLanguageQuery.set($any($event.target).value)"
              ></textarea>
              <div class="query-buttons">
                <button
                  class="btn btn-primary"
                  (click)="onNaturalLanguageQuery(naturalLanguageQuery())"
                  [disabled]="!naturalLanguageQuery().trim()"
                >
                  Get Smart Recommendations
                </button>
                @if (naturalLanguageQuery()) {
                  <button
                    class="btn btn-secondary"
                    (click)="clearNaturalLanguageQuery()"
                  >
                    Clear Query
                  </button>
                }
              </div>
            </div>
          </div>

          @if (aiRecommendations().length === 0 && !selectedHistoryEntry()) {
            <div class="recommendations-placeholder">
              <p>No recommendations available yet.</p>
              @if (!naturalLanguageQuery()) {
                <p>Try describing what you want to watch above!</p>
              } @else {
                <p>Try adjusting your query for better results.</p>
              }
            </div>
          } @else {
            @if (aiRecommendationReasoning()) {
              <div class="recommendation-reasoning">
                <h3>Why we think you'll like these:</h3>
                <p>{{ aiRecommendationReasoning() }}</p>
              </div>
            }

            <div class="media-grid">
              @for (recommendation of aiRecommendations(); track recommendation.tmdbId) {
                <app-media-card
                  [item]="{
                    id: recommendation.tmdbId,
                    title: recommendation.title,
                    name: recommendation.title,
                    overview: recommendation.overview,
                    poster_path: recommendation.poster_path.startsWith('/') ? recommendation.poster_path : '/' + recommendation.poster_path,
                    backdrop_path: '',
                    vote_average: recommendation.vote_average,
                    popularity: 0,
                    vote_count: 0,
                    genre_ids: [],
                    adult: false,
                    original_language: '',
                    release_date: recommendation.release_date,
                    first_air_date: recommendation.release_date,
                    origin_country: [],
                    original_name: recommendation.title
                  }"
                  [type]="recommendation.type === 'movie' ? 'movie' : 'tvshow'"
                  (share)="onShareMedia({
                    item: {
                      id: recommendation.tmdbId,
                      title: recommendation.title,
                      name: recommendation.title,
                      overview: recommendation.overview,
                      poster_path: recommendation.poster_path.startsWith('/') ? recommendation.poster_path : '/' + recommendation.poster_path,
                      backdrop_path: '',
                      vote_average: 0,
                      popularity: 0,
                      vote_count: 0,
                      genre_ids: [],
                      adult: false,
                      original_language: '',
                      release_date: '',
                      first_air_date: '',
                      origin_country: [],
                      original_name: recommendation.title
                    },
                    type: recommendation.type
                  })">
                </app-media-card>
              }
            </div>

            <div class="refresh-recommendations">
              <button class="btn btn-primary" (click)="loadAiRecommendations(true)">
                Refresh Recommendations
              </button>
            </div>
          }
        </div>
      }

      <!--
        AI Recommendations tab content - "For You" section
        This section displays personalized movie and TV show recommendations generated by
        the Genkit AI system based on the user's favorites only.
      -->
      @if (activeTab() === 'For You' && !isLoading() && !error()) {
        <div class="recommendations-container">
          @if (aiRecommendations().length === 0) {
            <div class="recommendations-placeholder">
              <p>No personalized recommendations available yet.</p>
              <p>Add some favorites to get recommendations based on your viewing history!</p>
            </div>
          } @else {
            @if (aiRecommendationReasoning()) {
              <div class="recommendation-reasoning">
                <h3>Why we think you'll like these:</h3>
                <p>{{ aiRecommendationReasoning() }}</p>
              </div>
            }

            <div class="media-grid">
              @for (recommendation of aiRecommendations(); track recommendation.tmdbId) {
                <app-media-card
                  [item]="{
                    id: recommendation.tmdbId,
                    title: recommendation.title,
                    name: recommendation.title,
                    overview: recommendation.overview,
                    poster_path: recommendation.poster_path.startsWith('/') ? recommendation.poster_path : '/' + recommendation.poster_path,
                    backdrop_path: '',
                    vote_average: recommendation.vote_average,
                    popularity: 0,
                    vote_count: 0,
                    genre_ids: [],
                    adult: false,
                    original_language: '',
                    release_date: recommendation.release_date,
                    first_air_date: recommendation.release_date,
                    origin_country: [],
                    original_name: recommendation.title
                  }"
                  [type]="recommendation.type === 'movie' ? 'movie' : 'tvshow'"
                  (share)="onShareMedia({
                    item: {
                      id: recommendation.tmdbId,
                      title: recommendation.title,
                      name: recommendation.title,
                      overview: recommendation.overview,
                      poster_path: recommendation.poster_path.startsWith('/') ? recommendation.poster_path : '/' + recommendation.poster_path,
                      backdrop_path: '',
                      vote_average: 0,
                      popularity: 0,
                      vote_count: 0,
                      genre_ids: [],
                      adult: false,
                      original_language: '',
                      release_date: '',
                      first_air_date: '',
                      origin_country: [],
                      original_name: recommendation.title
                    },
                    type: recommendation.type
                  })">
                </app-media-card>
              }
            </div>

            <div class="refresh-recommendations">
              <button class="btn btn-primary" (click)="loadAiRecommendations(true)">
                Refresh Recommendations
              </button>
            </div>
          }
        </div>
      }

      <!-- Guess the Movie tab content -->
      @if (activeTab() === 'Guess the Movie' && !isLoading() && !error()) {
        <app-guess-movie></app-guess-movie>
      }
    </div>
  </div>
</section>
